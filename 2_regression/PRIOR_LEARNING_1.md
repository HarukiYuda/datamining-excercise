# 事前学習その１: 回帰の考え方

### 出力を説明する変数を探す
回帰（回帰分析）に関する説明は，書籍等で調べてください．ここでは取っ掛かりとなる考え方の基本だけ説明します．

具体的な例を使いながら説明することにしましょう．アメリカのボストンの住宅価格に関するデータセットが公開されています．別タブや別ウィンドウで開いてみましょう（外部リンクです）．

https://www.cs.toronto.edu/~delve/data/boston/bostonDetail.html

英語ですが，頑張って軽く目を通しましょう．各データが14項目で構成されています．一番最後の `MEDV` が住宅価格（正確には中央値）です．1番目の `CRIM` が犯罪発生率，11番目の `PTRATIO` がその区画の教員一人当たりの生徒数，など，確かに住宅価格に影響しそうな項目が並んでいます．

とりあえずここでの目的を「**住宅価格に影響を及ぼす要因は何か？**」を知ることだとしましょう．そのためには `MEDV` を「出力の値」として，それが他の項目からどのような影響を受けるかがわかればよさそうです．

例えば，犯罪発生率が 1 &#37; 下がったら，住宅価格がこれだけ上がります，とか，逆に，教員一人当たりの生徒数が増えても減っても住宅価格には影響しない，など，各項目が「出力の値」`MEDV` に与える影響がわかれば，色々とその結果を活かせそうですよね？ 住宅価格を上げる，もしくは下げるためにはどうしたらよいかといった政策を考えるもよし，このようなデータがあるからもっとこの住宅を安く売ってくれと不動産業者と交渉するもよし・・．

回帰を使えば，このように「出力を説明する変数を探す」ことができます．

***
### 少しだけ，数式で
コードの実行結果を理解する上でも必要なので，少しだけ数式を使って説明します．
例えば `MEDV` の値を予想するために `CRIM` と `PTRATIO` を使った次のような「モデル」を作ります．

![回帰の説明](./img/reg_basic_eq.png)

データとしては出力 `MEDV` と２つの入力 `CRIM` と `PTRATIO` が506区画分，揃っています．回帰では，この数式の `(定数)`, `(CRIMの係数)`, `(PTRATIOの係数)` を調整して，手持ちのデータの２つの入力 `CRIM` と `PTRATIO` を使って出力 `MEDV` を適切に予測できるようにします．そうすることで，２つの入力 `CRIM` と `PTRATIO` がどのくらい `MEDV` の予測に「効いてくるか」がわかります．

例えば解析の結果，`(CRIMの係数)` が `-2.0` だったとします．すると犯罪発生率が上がるほど住宅価格は下がります．同じ解析を日本の住宅価格データに対しておこなって，係数が `-0.5` だったとしたら，（国の違いによる価格の調整などは必要だとして）日本のほうが犯罪発生率はあまり気にしていないようだ，ということになります．

また，`(PTRATIOの係数)` がゼロだったとしましょう．すると，教員一人当たりの生徒数は住宅価格には関係しない，ということを言えます．

このように，数式でモデルを作り，係数（パラメータと言います）をデータに合うように調整することでデータを解析するというのは，統計的な解析や機械学習の基本です．あとでコードを実行してみればわかりますが，値が色々と出力されてきます．それが上で説明した係数に対応している，ということがわからないと，結果の解釈もできません．最低限度の数式と考え方くらいは，理解するようにしましょう．

***
### 説明変数に関する注意
回帰で注意すべきは，どのような変数をモデルに設定するか，です．例えば次のようなモデルを考えてみましょう．

![多重共線性](./img/reg_variable.png)

とりあえず1行目だけ見てもらえば十分です．変数として `CRIM` と `CRIMの2倍の値` を使っています．変数が2つあるようですが，実際には `CRIM` 1つしか使っていないわけです．だから `係数1` と `係数2` の値を比較しても，なんの意味もありません．

これは極端な例ですが，例えば `CRIM` と `PTRATIO` について，`CRIM` の値が増えると `PTRATIO` も増える，などの密接な関係があったとしましょう．そうすると，先ほどの極端な例のように係数の比較に意味がない，ということになります．

これは **多重共線性** というもので，回帰でデータを解析する際には注意すべき点です．しっかりと考えて説明変数を設定する，などの対応が必要になります．詳しくは実践するなかで，数式の部分も含めて理解していってください．

***
### モデルの注意事項
現実がこのようなモデルに当てはまるかどうかは，実はわかりません．統計的な解析や機械学習では，「現実のこの部分を，このようなモデルで表現する」と勝手に決めて，例えば誤差を小さくするように係数（パラメータ）を調整します．何かしらの結果は出てきますが，モデルが見当外れならその解析結果は全然的外れなものになってしまうでしょう．使うモデル（解析手法）を変えたら，データ解析の結果がガラッと変わってしまった，ということもよくあります．

どのようなモデルを使うべきかを考えるのは人間です．データ解析としては，説得力のある結果を導けるように，数学的な部分も含めて自分が使っているモデルについて理解したうえで，結果を解釈するようにしましょう．

***
### モデルの予測と実際のデータの比較
回帰を使えば，上で説明したような係数を求めることができます．でもそれがどのくらい実際のデータを説明するのでしょうか．100 &#37; 説明できる，ということはまずありえません．実際のデータは何かしらの誤差やノイズを含んでいます．また，モデルが不十分，例えば `MEDV` を説明するために重要な項目を使わずにモデルを作っていたりしたら，予測の精度は悪いでしょう．

そこで，`モデルから予測した出力の値` と `実際の出力の値` の差を調べてみることも時には必要になります．これを `残差誤差` と言います．残差誤差を調べてみて，あまりに誤差が大きい場合にはそのモデルの説明能力が低く，結論に説得力がないかもしれません．また線形回帰には決定係数 *R*<sup>2</sup> と呼ばれる量もあります．どのようなものか，各自で調べてみてください．

***
### データの分割
与えられたデータを解析する，ということも大切です．でも，与えられたデータだけを解析しただけでは不十分な場合もあります．たまたまそのデータだったからこの結論，ということもあります．そもそもの目的が「データを解析して，将来の予測に活かす」ことなら，今のデータを解析するだけではなく，これから届くデータでどのような性能を発揮するかを検証する必要もあります．

でも，まだ手元にないデータを使って解析をする，ということはできません．どのようにしたらいいのでしょうか？

そのための素朴な方法は，与えられたデータを二つに分けることです．

1. 訓練データ
1. テストデータ

訓練データを使って係数（パラメータ）を調整し（これを学習と言います），テストデータで性能を検証します．もともと訓練に使うはずだったデータの一部をテストデータにしたわけですから，「入力の値」と「出力の値」が揃っています．だから，モデルから予測した値と実際の値の誤差を調べることができて，モデルの性能を調べることができるわけですね．

これは素朴に二つにデータを分けるだけでしたが，もう一段階高度な検討をできる **交差検証法 (Cross Validation)** と呼ばれる手法もあります（これも調べれば簡単に理解できますので，各自で）．

***
### プロットの大切さ
元のデータや解析結果を数字として見ているだけでは，よくわからない部分もあります．実際にプロットしてみると「あれ，これはデータがおかしいのでは」「このデータならこうやって解析するべきかも」など，色々な知見を得られることもありますので，ぜひ，プロットをしてデータを眺める習慣を身につけてください．

ただし，人間がプロットして「見る」ことができるのは3次元まで，です．とりあえずいくつかの特徴量（入力など）を選び，3次元は少し見づらいので，2次元でプロットしてみましょう．プロットする特徴量を変えるとまた新しい発見があるはずです．

あとでサンプルコードを見るとわかるように，データ解析をするプログラムのコードそのものは，非常に簡単です．データ解析の大部分は，地道にデータをプロットをしながら，データにおかしなところがないかチェックしたり，どのように解析するかを決めたり，解析しやすいようにデータを変換したり，といった泥臭い作業です．面倒ですが，頑張りましょう．

***
### 補足: データ形式について

この演習では **CSV** という形式でデータを準備します．Excelでも簡単に作れるもので，「ファイル」 &rarr; 「インポート...」などとすればCSV形式のファイルを読み込めますし，逆に「ファイルを別名で保存」などでCSV形式を指定して保存することもできます．このあたりはExcelのバージョンや使っている機種によっても操作が変わると思いますので，調べてください．

なお「CSV」とは「Comma Separated Value」の略で，カンマ `,` で区切られていることを意味しています．また，別の人がデータを見たときにわかりやすいように，データの1行目に（場合によっては複数行に渡って）項目の名前などの説明をいれておくとよいでしょう．もちろんPythonでデータを読み込む際には，その1行目を特別扱いするなどが必要になります．

Pythonでは，データベースに直接アクセスすることもできますし，もちろん画像データなども扱うことができます．必要に応じて各自で調べてみてください．

***
### 便利なモジュール

コード [`regression.py`](./regression.py) を開いてみましょう（また別タブなどで）．コードを眺めて，何をしているかを推測してみてください．

コードの3行目，
```Python
from sklearn import linear_model
```
がポイントです．線形回帰の方法を使うために `sklearn` のなかの `linear_model` という関数を読み込みますよ，と宣言しています．もう誰かが線形回帰の方法を作ってくれているわけですね．

`sklearn` というのは [scikit-learn（外部リンク）](http://scikit-learn.org/) のことで，非常にたくさんのデータ解析や機械学習の手法がすでに揃っています．

コード [`regression.py`](./regression.py) の14行目と15行目
```python
regr = linear_model.LinearRegression()
regr.fit(inputs, outputs)
```
で実際の解析を実行しています．14行目で `linear_model` のなかの `LinearRegression()` という関数を使いますよ，と宣言して，15行目で入力 `inputs` と出力 `outputs` を使ってフィッティング(fit)を実行しています．これでデータ解析は終わりです．`regr` というのは，このプログラム内での解析器（学習器）の名前で，これは適当に変えても大丈夫です．Python の変数には数値だけではなくて色々なものを入れられます．今の場合には解析器，つまり線形回帰ですよ，というモデルを変数に入れている，というイメージです．

解析の結果として得られた係数は，`.coef_` というところに格納されています．今は解析器の名前を `regr` にしていましたから，17行目で `regr.coef_`，つまり `regr` という解析器の `.coef_` を出力させる，ということをしています．

他の部分はファイルの読み込みと，入力と出力データの準備（`numpy` 配列の整形作業ですね），あとはプロットのためのコードです．

自分でこれを書け，と言われると難しいと思いますが，軽く読むと意味そのものは理解できるのではないでしょうか？ 英語の文章の単語だけ拾い読みして意味を推測する，という感じでいれば，Pythonは非常に読みやすいはずです．

あとはよくわからない単語（関数ですね）などを，気になったらその都度自分でweb等で調べる，ということをしてください．この後の演習で実際に試しながら，そしてあれこれと自分でコードを改造してみて，エラーメッセージを見ながら作業をすると，理解が深まります．

***
[>> 回帰問題のトップページに戻る](./README.md)
***
<img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"> &nbsp; Jun Ohkubo
